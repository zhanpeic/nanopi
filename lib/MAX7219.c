#include <stdio.h>
#include <linux/types.h>
#include "libfahw-filectl.h"
#include "libfahw-spi.h"
#include "libfahw-MAX7219.h"
#include "common.h"

static unsigned int spiMode = 0;
static unsigned char spiBits = 8;
static unsigned int spiDivider = 332;
static unsigned int spiSpeed = 100000;
static unsigned short spiDelay;

unsigned char Max7219CharMap[38][9]={
        {'0', 0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//0
        {'1', 0x10,0x18,0x14,0x10,0x10,0x10,0x10,0x10},//1
        {'2', 0x7E,0x2,0x2,0x7E,0x40,0x40,0x40,0x7E},//2
        {'3', 0x3E,0x2,0x2,0x3E,0x2,0x2,0x3E,0x0},//3
        {'4', 0x8,0x18,0x28,0x48,0xFE,0x8,0x8,0x8},//4
        {'5', 0x3C,0x20,0x20,0x3C,0x4,0x4,0x3C,0x0},//5
        {'6', 0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C,0x0},//6
        {'7', 0x3E,0x22,0x4,0x8,0x8,0x8,0x8,0x8},//7
        {'8', 0x0,0x3E,0x22,0x22,0x3E,0x22,0x22,0x3E},//8
        {'9', 0x3E,0x22,0x22,0x3E,0x2,0x2,0x2,0x3E},//9
        {'A', 0x8,0x14,0x22,0x3E,0x22,0x22,0x22,0x22},//A
        {'B', 0x3C,0x22,0x22,0x3E,0x22,0x22,0x3C,0x0},//B
        {'C', 0x3C,0x40,0x40,0x40,0x40,0x40,0x3C,0x0},//C
        {'D', 0x7C,0x42,0x42,0x42,0x42,0x42,0x7C,0x0},//D
        {'E', 0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C},//E
        {'F', 0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},//F
        {'G', 0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C},//G
        {'H', 0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44},//H
        {'I', 0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C},//I
        {'J', 0x3C,0x8,0x8,0x8,0x8,0x8,0x48,0x30},//J
        {'K', 0x0,0x24,0x28,0x30,0x20,0x30,0x28,0x24},//K
        {'L', 0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C},//L
        {'M', 0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81},//M
        {'N', 0x0,0x42,0x62,0x52,0x4A,0x46,0x42,0x0},//N
        {'O', 0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//O
        {'P', 0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20},//P
        {'Q', 0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D},//Q
        {'R', 0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21},//R
        {'S', 0x0,0x1E,0x20,0x20,0x3E,0x2,0x2,0x3C},//S
        {'T', 0x0,0x3E,0x8,0x8,0x8,0x8,0x8,0x8},//T
        {'U', 0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1C},//U
        {'V', 0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},//V
        {'W', 0x0,0x49,0x49,0x49,0x49,0x2A,0x1C,0x0},//W
        {'X', 0x0,0x41,0x22,0x14,0x8,0x14,0x22,0x41},//X
        {'Y', 0x41,0x22,0x14,0x8,0x8,0x8,0x8,0x8},//Y
        {'Z', 0x0,0x7F,0x2,0x4,0x8,0x10,0x20,0x7F},//Z
        {'0', 0x8,0x7F,0x49,0x49,0x7F,0x8,0x8,0x8}, //?
        {'0', 0xFE,0xBA,0x92,0xBA,0x92,0x9A,0xBA,0xFE},//?
};

unsigned char convertCharmap(unsigned char charmap[8])
{
    int bit[8][8];
    int i,j;
        
    for (i = 0; i < 8; i++) {
        for (j = 0; j < 8; j++) {
            bit[i][j] = (charmap[i] & (1<<j)) >> j;
        }
    }
    
    for (i = 0; i < 8; i++) {    
        charmap[i] = 0;
    }
    
    for (i = 0; i < 8; i++) {
        for (j = 0; j < 8; j++) {
            if (i == 0) {
                charmap[j] |= bit[i][j]<<7;        
            }
            else { 
                charmap[j] |= bit[i][j]<<(i-1);    
            }
        }
    }
    return 0;
}

static int MAX7219WriteByte(int devFD, unsigned char address, unsigned char data)
{
    // don't know why open this the MAX7219 can't work
    // clearLastError();
    unsigned char tx[2] = {address, data};
    int writeLen = sizeof(tx);
    if (writeBytesToSPI(devFD, tx, writeLen, spiDelay, spiSpeed, spiBits) == -1){
        return -1;
    }
    return 0;
}

EXPORT int MAX7219DispChar(int devFD, unsigned char c)
{
    clearLastError();
    int i = 0;
    int index = -1;
    int address,data;
    for (i=0; i<38; i++) {
        if (Max7219CharMap[i][0] == c) {
            index = i;
            break;
        }
    }
    if(index < 0 || index > 37) {
        setLastError("Unsupported charac to MAX7219");
        return -1;
    }

    for (i=0; i<8; i++)
    {   
        address = i + 1;
        data = Max7219CharMap[index][address];
        if (MAX7219WriteByte(devFD, address, data) == -1) {
            setLastError("Fail to Display %c on MAX7219", c);
            return -1;
        }
    }
    return 0;
}

EXPORT int MAX7219Init() 
{
    clearLastError();
    int devFD;
    int i;
    if ((devFD = openHW(SPI0_PATH, O_RDWR)) < 0) {
        setLastError("Fail to open SPI device MAX7219");
        return -1;
    } 

    if (setSPIDataMode(devFD, spiMode) == -1 ) {
        setLastError("Fail to set MAX7219 SPI mode");
        closeHW(devFD);
        return -1;
    }

    if (setSPIWriteBitsPerWord(devFD, spiBits) == -1 ) {
        setLastError("Fail to set MAX7219 SPI bits");
        closeHW(devFD);
        return -1;
    }

    if (setSPIClockDivider(devFD, spiSpeed) == -1 ) {
        setLastError("Fail to set MAX7219 SPI clock divider");
        closeHW(devFD);
        return -1;
    }

    MAX7219WriteByte(devFD, 0x09, 0x00); 
    MAX7219WriteByte(devFD, 0x0a, 0x03);  
    MAX7219WriteByte(devFD, 0x0b, 0x07);  
    MAX7219WriteByte(devFD, 0x0c, 0x01);   
    MAX7219WriteByte(devFD, 0x0f, 0x00); 

    for (i = 0; i<38; i++) {
        convertCharmap(&Max7219CharMap[i][1]);
    }
    return devFD;
}

EXPORT int MAX7219CleanScreen(int devFD)
{
    clearLastError();
    int i,address, data;    
    data = 0;
    for (i=0; i<8; i++)
    {   
        address = i + 1;
        if (MAX7219WriteByte(devFD, address, data) == -1) {
            setLastError("Fail to clean MAX7219");
            return -1;
        }
    }
    return 0;
}

EXPORT void MAX7219DeInit(int devFD)
{
    clearLastError();
    MAX7219CleanScreen(devFD);
    closeHW(devFD);    
}
